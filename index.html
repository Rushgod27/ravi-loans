<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Loan Hierarchy System</title>

<style>
body{margin:0;font-family:system-ui;background:#f1f5f9;}
.hidden{display:none;}
.card{
  background:#fff;
  padding:16px;
  margin:16px;
  border-radius:12px;
  box-shadow:0 2px 8px rgba(0,0,0,0.05);
}
input{
  width:100%;
  padding:12px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid #ddd;
}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:8px;
  background:#2563eb;
  color:#fff;
  font-weight:600;
}
.header{
  background:#2563eb;
  color:#fff;
  padding:14px;
  text-align:center;
  font-weight:600;
  position:relative;
}
.logout{
  position:absolute;
  right:15px;
  top:14px;
  font-size:14px;
  cursor:pointer;
}
.owner-item{
  padding:10px;
  border-bottom:1px solid #eee;
}
.small{
  font-size:12px;
  color:#6b7280;
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginSection">
  <div class="card">
    <h3>Login</h3>
    <input type="email" id="email" placeholder="Email">
    <input type="password" id="password" placeholder="Password">
    <button onclick="loginUser()">Login</button>
  </div>
</div>

<!-- MAIN APP -->
<div id="appSection" class="hidden">

<div class="header">
  Loan Management System
  <span class="logout" onclick="logoutUser()">Logout</span>
</div>

<!-- FORCE PASSWORD CHANGE -->
<div id="forcePasswordSection" class="hidden">
  <div class="card">
    <h3>Change Password</h3>
    <input type="password" id="newPassword" placeholder="New Password">
    <button onclick="updatePasswordNow()">Update Password</button>
  </div>
</div>

<!-- BOSS DASHBOARD -->
<div id="bossDashboard" class="hidden">

  <div class="card">
    <h3>Add Owner</h3>
    <input id="ownerName" placeholder="Owner Name">
    <input id="ownerPhone" placeholder="Owner Phone">
    <input id="ownerEmail" placeholder="Owner Email">
    <input id="ownerPassword" placeholder="Temporary Password">
    <button onclick="addOwner()">Create Owner</button>
  </div>

  <div class="card">
    <h3>Owners List</h3>
    <div id="ownersList">Loading...</div>
  </div>

</div>

</div>

<script type="module">

import { initializeApp, getApp } from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";

import {
  getAuth,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  updatePassword,
  onAuthStateChanged,
  signOut
} from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

import {
  getFirestore,
  doc,
  setDoc,
  getDoc,
  getDocs,
  collection,
  query,
  where
} from 
"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

/* FIREBASE CONFIG */
const firebaseConfig = {
  apiKey: "AIzaSyCX4nJv28LRTtCcH3sjj-LUiXzYfxK3SDM",
  authDomain: "loan-management-system-a5bd8.firebaseapp.com",
  projectId: "loan-management-system-a5bd8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUserId = null;
let currentUserRole = null;

/* LOGIN */
window.loginUser = async function(){

  const emailVal = document.getElementById("email").value.trim();
  const passVal = document.getElementById("password").value.trim();

  if(!emailVal || !passVal){
    alert("Enter email and password");
    return;
  }

  try{
    await signInWithEmailAndPassword(auth,emailVal,passVal);
  }catch(err){
    alert(err.message);
  }
};

/* AUTH STATE */
onAuthStateChanged(auth, async(user)=>{

  if(user){

    currentUserId = user.uid;

    const snap = await getDoc(doc(db,"users",user.uid));

    if(!snap.exists()){
      alert("User not registered.");
      await signOut(auth);
      return;
    }

    const userData = snap.data();
    currentUserRole = userData.role;

    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("appSection").classList.remove("hidden");

    if(userData.mustChangePassword){
      document.getElementById("forcePasswordSection").classList.remove("hidden");
      return;
    }

    if(currentUserRole === "boss"){
      document.getElementById("bossDashboard").classList.remove("hidden");
      loadOwners();
    }

  }else{
    document.getElementById("loginSection").classList.remove("hidden");
    document.getElementById("appSection").classList.add("hidden");
  }

});

/* UPDATE PASSWORD */
window.updatePasswordNow = async function(){

  const newPass = document.getElementById("newPassword").value.trim();

  if(newPass.length < 6){
    alert("Password must be at least 6 characters.");
    return;
  }

  try{

    await updatePassword(auth.currentUser, newPass);

    await setDoc(doc(db,"users",currentUserId),{
      mustChangePassword:false
    },{merge:true});

    document.getElementById("forcePasswordSection").classList.add("hidden");

    alert("Password updated successfully.");

    if(currentUserRole === "boss"){
      document.getElementById("bossDashboard").classList.remove("hidden");
      loadOwners();
    }

  }catch(err){
    alert(err.message);
  }

};

/* LOGOUT */
window.logoutUser = async function(){
  await signOut(auth);
};

/* ADD OWNER */
window.addOwner = async function(){

  if(currentUserRole !== "boss"){
    alert("Access denied");
    return;
  }

  const name = ownerName.value.trim();
  const phone = ownerPhone.value.trim();
  const emailVal = ownerEmail.value.trim();
  const passwordVal = ownerPassword.value.trim();

  if(!name || !phone || !emailVal || !passwordVal){
    alert("Fill all fields");
    return;
  }

  let secondaryApp;

  try{
    secondaryApp = getApp("SecondaryApp");
  }catch{
    secondaryApp = initializeApp(firebaseConfig,"SecondaryApp");
  }

  const secondaryAuth = getAuth(secondaryApp);

  try{

    const userCred = await createUserWithEmailAndPassword(
      secondaryAuth,
      emailVal,
      passwordVal
    );

    await setDoc(doc(db,"users",userCred.user.uid),{
      name:name,
      phone:phone,
      email:emailVal,
      role:"owner",
      bossId:currentUserId,
      mustChangePassword:true,
      createdAt:Date.now()
    });

    await secondaryAuth.signOut();

    alert("Owner created successfully.");

    ownerName.value="";
    ownerPhone.value="";
    ownerEmail.value="";
    ownerPassword.value="";

    loadOwners();

  }catch(err){
    alert(err.message);
  }
};

/* LOAD OWNERS */
async function loadOwners(){

  const q = query(
    collection(db,"users"),
    where("role","==","owner"),
    where("bossId","==",currentUserId)
  );

  const snap = await getDocs(q);

  let html="";

  snap.forEach(doc=>{
    const data=doc.data();
    html+=`
      <div class="owner-item">
        <b>${data.name}</b><br>
        ðŸ“ž ${data.phone}<br>
        âœ‰ ${data.email}<br>
        <div class="small">
          Created: ${new Date(data.createdAt).toLocaleDateString()}
        </div>
      </div>
    `;
  });

  document.getElementById("ownersList").innerHTML = html || "No owners found.";
}

</script>
</body>
</html>